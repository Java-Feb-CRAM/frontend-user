<h1 class="mt-5">Checkout</h1>
<p>Checking out as a Guest</p>

<form [formGroup]="bookingForm" (ngSubmit)="onSubmit()">
  <div class="card mt-3">
    <div class="card-header">Your Info</div>
    <div class="card-body">
      <div class="form-group row">
        <label for="guestEmail" class="col-sm-2 col-form-label">Email</label>
        <div class="col-sm-10">
          <input
            type="email"
            formControlName="guestEmail"
            class="form-control"
            id="guestEmail"
            [ngClass]="{
              'is-invalid':
                bookingForm.controls.guestEmail.invalid &&
                (bookingForm.controls.guestEmail.dirty ||
                  bookingForm.controls.guestEmail.touched),
              'is-valid': bookingForm.controls.guestEmail.valid
            }"
          />
          <div
            class="invalid-feedback"
            *ngIf="bookingForm.controls.guestEmail.errors"
          >
            <div *ngIf="bookingForm.controls.guestEmail.errors.required">
              Email is required
            </div>
            <div *ngIf="bookingForm.controls.guestEmail.errors.email">
              Email must be a valid email address
            </div>
          </div>
        </div>
      </div>
      <div class="form-group row">
        <label for="guestPhone" class="col-sm-2 col-form-label">Phone</label>
        <div class="col-sm-10">
          <input
            type="tel"
            formControlName="guestPhone"
            class="form-control"
            id="guestPhone"
            [ngClass]="{
              'is-invalid':
                bookingForm.controls.guestPhone.invalid &&
                (bookingForm.controls.guestPhone.dirty ||
                  bookingForm.controls.guestPhone.touched),
              'is-valid': bookingForm.controls.guestPhone.valid
            }"
          />
          <div
            class="invalid-feedback"
            *ngIf="bookingForm.controls.guestPhone.errors"
          >
            <div *ngIf="bookingForm.controls.guestPhone.errors.required">
              Phone number is required
            </div>
            <div *ngIf="bookingForm.controls.guestPhone.errors.pattern">
              Phone number must follow xxx-xxx-xxxx
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mt-3">
    <div class="card-header">
      <div class="d-flex justify-content-between">
        <div class="align-self-center">
          Passengers
          <span class="badge badge-secondary">{{ passengers().length }}</span>
        </div>
        <div>
          <button
            type="button"
            class="btn btn-primary"
            (click)="addPassenger()"
          >
            Add Passenger
          </button>
        </div>
      </div>
    </div>
    <div class="card-body" formArrayName="passengers">
      <div
        class="card mt-1"
        *ngFor="let passenger of passengers().controls; let i = index"
        [formGroupName]="i"
      >
        <div class="card-header">
          <div class="d-flex justify-content-between">
            <div class="align-self-center">Passenger {{ i + 1 }}</div>
            <div>
              <button
                class="btn btn-danger btn-sm"
                (click)="removePassenger(i)"
                *ngIf="i !== 0"
              >
                Remove
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group col">
              <label for="passengerGivenName">First Name</label>
              <input
                type="text"
                formControlName="givenName"
                class="form-control"
                id="passengerGivenName"
                [ngClass]="{
                  'is-invalid':
                    passenger.get('givenName')!.invalid &&
                    (passenger.get('givenName')!.dirty ||
                      passenger.get('givenName')!.touched),
                  'is-valid': passenger.get('givenName')!.valid
                }"
              />
              <div
                class="invalid-feedback"
                *ngIf="passenger.get('givenName')!.errors"
              >
                <div *ngIf="passenger.get('givenName')!.errors!.required">
                  First name is required
                </div>
              </div>
            </div>
            <div class="form-group col">
              <label for="passengerFamilyName">Last Name</label>
              <input
                type="text"
                formControlName="familyName"
                class="form-control"
                id="passengerFamilyName"
                [ngClass]="{
                  'is-invalid':
                    passenger.get('familyName')!.invalid &&
                    (passenger.get('familyName')!.dirty ||
                      passenger.get('familyName')!.touched),
                  'is-valid': passenger.get('familyName')!.valid
                }"
              />
              <div
                class="invalid-feedback"
                *ngIf="passenger.get('familyName')!.errors"
              >
                <div *ngIf="passenger.get('familyName')!.errors!.required">
                  Last name is required
                </div>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col">
              <label for="passengerDob">Birthday</label>
              <div class="input-group">
                <input
                  formControlName="dob"
                  class="form-control"
                  placeholder="yyyy-mm-dd"
                  name="dp"
                  ngbDatepicker
                  #d="ngbDatepicker"
                  id="passengerDob"
                  [ngClass]="{
                    'is-invalid':
                      passenger.get('dob')!.invalid &&
                      (passenger.get('dob')!.dirty ||
                        passenger.get('dob')!.touched),
                    'is-valid': passenger.get('dob')!.valid
                  }"
                />

                <div class="input-group-append">
                  <button
                    class="btn btn-outline-secondary calendar"
                    (click)="d.toggle()"
                    type="button"
                  ></button>
                </div>
                <div
                  class="invalid-feedback"
                  *ngIf="passenger.get('dob')!.errors"
                >
                  <div *ngIf="passenger.get('dob')!.errors!.required">
                    Birthday is required
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group col">
              <label for="passengerGender">Gender</label>
              <select
                class="form-control"
                id="passengerGender"
                formControlName="gender"
                [ngClass]="{
                  'is-invalid':
                    passenger.get('gender')!.invalid &&
                    (passenger.get('gender')!.dirty ||
                      passenger.get('gender')!.touched),
                  'is-valid': passenger.get('gender')!.valid
                }"
              >
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
              <div
                class="invalid-feedback"
                *ngIf="passenger.get('gender')!.errors"
              >
                <div *ngIf="passenger.get('gender')!.errors!.required">
                  Gender is required
                </div>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col">
              <label for="passengerAddress">Address</label>
              <input
                type="text"
                formControlName="address"
                class="form-control"
                id="passengerAddress"
                [ngClass]="{
                  'is-invalid':
                    passenger.get('address')!.invalid &&
                    (passenger.get('address')!.dirty ||
                      passenger.get('address')!.touched),
                  'is-valid': passenger.get('address')!.valid
                }"
              />
              <div
                class="invalid-feedback"
                *ngIf="passenger.get('address')!.errors"
              >
                <div *ngIf="passenger.get('address')!.errors!.required">
                  Address is required
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ul class="list-group mt-3">
    <li *ngFor="let flight of flights" class="list-group-item">
      {{ flight.route.originAirport.iataId }} &rarr;
      {{ flight.route.destinationAirport.iataId }}
      &mdash;
      {{ flight.seatPrice | currency: "USD" }}
      &times;
      {{ passengers().length }}
      =
      {{ flight.seatPrice * passengers().length | currency: "USD" }}
    </li>
    <li class="list-group-item">
      <b>Subtotal: {{ total | currency: "USD" }}</b>
    </li>
    <li class="list-group-item">Tax: {{ tax | currency: "USD" }}</li>
    <li class="list-group-item">
      <strong>Grand Total: {{ grandTotal | currency: "USD" }}</strong>
    </li>
  </ul>
  <button
    type="submit"
    class="btn btn-success btn-lg btn-block mt-3"
    [disabled]="!bookingForm.valid"
  >
    Pay & Book
  </button>
</form>
<pre>
  {{ this.bookingForm.value | json }}
</pre>
